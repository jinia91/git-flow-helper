name: Auto Merge on Approve and Label

on:
  pull_request_review:
    types: [submitted]
  pull_request_target:
    types: [labeled, unlabeled]

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          fetch-depth: 0

      - name: 머지 가능 여부 체크
        id: check-label-and-approval
        uses: actions/github-script@v6
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({ owner, repo, issue_number });
            const hasMergeLabel = labels.some(label => label.name === 'merge');

            const { data: reviews } = await github.rest.pulls.listReviews({ owner, repo, pull_number: issue_number });
            const approved = reviews.some(review => review.state === 'APPROVED');

            if (hasMergeLabel && approved) {
              return true;
            } else {
              console.log('PR does not have "merge" label and/or sufficient approvals.');
              return false;
            }
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Merge the PR
        if: steps.check-label-and-approval.outputs.result == 'true'
        uses: peter-evans/merge-pull@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          method: merge
          delete_branch: true
